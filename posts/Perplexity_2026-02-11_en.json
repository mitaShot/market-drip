return items.map(item => {
  const j = item.json;

  // 1) 차트 결과가 배열([ {..} ])로 들어온 경우 대비
  // (예: pythonResult 라는 키로 들어왔다고 가정. 실제 키 이름에 맞게 수정)
  // 만약 merge로 그냥 상위에 필드가 섞였다면 이 블록은 생략 가능.
  const chartRaw = j.pythonResult?.[0] ?? j.chartResult?.[0] ?? null;

  // 2) 현재 item.json에 이미 chart_* / image_* 필드가 섞여있는 케이스 처리
  const src = chartRaw ?? j;

  // 3) generated 블록 "추가"
  j.generated = j.generated ?? {};
  j.generated.charts = j.generated.charts ?? [];

  j.generated.charts.push({
    kind: "mplfinance_stock_analysis",
    ticker: src.ticker,
    chart_filename: src.chart_filename,
    chart_path: src.chart_path,
    analysis: {
      ko: src.analysis_ko,
      jp: src.analysis_jp,
      en: src.analysis_en,
    },
    image_alt: {
      ko: src.image_alt_ko,
      jp: src.image_alt_jp,
      en: src.image_alt_en,
    },
    image_caption: {
      ko: src.image_caption_ko,
      jp: src.image_caption_jp,
      en: src.image_caption_en,
    },
    image_base64: src.image_base64,
  });

  // 4) (선택) 루트에 섞여 들어온 chart/image 필드가 보기 싫으면 제거
  // delete j.chart_filename; delete j.chart_path; ... 필요 시만

  return { json: j };
});
